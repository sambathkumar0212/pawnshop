{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit Loan{% else %}New Loan{% endif %} - Pawnshop Management{% endblock %}

{% block content %}
<div class="container-fluid py-2">
    <div class="row mb-2">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="fas fa-hand-holding-usd me-2"></i>
                    {% if form.instance.pk %}Edit Loan{% else %}New Loan{% endif %}
                </h2>
                <a href="{% url 'loan_list' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Back to Loans
                </a>
            </div>
        </div>
    </div>

    <!-- Add debugging information and error messages in a collapsible panel -->
    {% if messages or form.errors %}
    <div class="row mb-2">
        <div class="col">
            <div class="accordion" id="accordionMessages">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingMessages">
                        <button class="accordion-button p-2 {% if not messages and not form.errors %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMessages" aria-expanded="{% if messages or form.errors %}true{% else %}false{% endif %}" aria-controls="collapseMessages">
                            <i class="fas fa-exclamation-triangle me-2 text-warning"></i>Messages & Errors
                        </button>
                    </h2>
                    <div id="collapseMessages" class="accordion-collapse collapse {% if messages or form.errors %}show{% endif %}" aria-labelledby="headingMessages" data-bs-parent="#accordionMessages">
                        <div class="accordion-body p-2">
                            {% if messages %}
                                {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show py-2 mb-2" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                                {% endfor %}
                            {% endif %}
                            
                            {% if form.errors %}
                            <div class="alert alert-danger py-2 mb-2">
                                <h6 class="alert-heading">Please correct the following errors:</h6>
                                <ul class="mb-0 small">
                                    {% for field in form %}
                                        {% for error in field.errors %}
                                        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                    {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Alert container for dynamic notifications -->
    <div id="alertContainer" class="mb-2"></div>
    
    <div class="row">
        <div class="col-lg-12">
            <form method="post" id="loanForm" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                <input type="hidden" name="customer_face_capture" id="customerFaceCapture" value="{% if form.instance.customer_face_capture %}{{ form.instance.customer_face_capture|escapejs }}{% endif %}">
                <input type="hidden" name="item_photos" id="itemPhotosData" value="">
                <input type="hidden" name="interest_rate" id="id_interest_rate" value="12.00">
                
                <div class="card shadow mb-3">
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <!-- Left column - essential information -->
                            <div class="col-md-8">
                                <!-- Primary Loan Info Section -->
                                <div class="card mb-2">
                                    <div class="card-header bg-light py-1 d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-info-circle me-1"></i>Primary Loan Info
                                        </h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                {{ form.customer|as_crispy_field }}
                                            </div>
                                            <div class="col-md-6">
                                                {{ form.branch|as_crispy_field }}
                                            </div>
                                            <div class="col-md-6">
                                                {{ form.scheme|as_crispy_field }}
                                                <div id="scheme-info" class="card bg-light py-1 px-2 small mb-0 mt-1">
                                                    <span id="scheme-details"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                {{ form.issue_date|as_crispy_field }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gold Item Details Section -->
                                <div class="card">
                                    <div class="card-header bg-light py-1 d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-gem me-1"></i>Gold Item Details
                                        </h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-2">
                                            <!-- First row: Item Name (left) and Ornament Type/Item Category (right) -->
                                            <div class="col-md-6">
                                                {{ form.item_name|as_crispy_field }}
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        {{ form.item_category|as_crispy_field }}
                                                    </div>
                                                    <div class="ms-2 mt-4">
                                                        <div class="d-flex align-items-center">
                                                            <small class="text-muted me-1 fw-bold">Total Items:</small>
                                                            <div class="input-group input-group-sm" style="max-width: 80px;">
                                                                <span class="input-group-text bg-success text-white py-0">
                                                                    <i class="fas fa-list-ol"></i>
                                                                </span>
                                                                <input type="text" class="form-control form-control-sm py-0" id="calculatedTotalItems" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Second row: Item Description (left) and Today's 22K Gold Price (right) -->
                                            <div class="col-md-6">
                                                {{ form.item_description|as_crispy_field }}
                                            </div>
                                            <div class="col-md-6">
                                                {{ form.market_price_22k|as_crispy_field }}
                                            </div>
                                            
                                            <!-- Remaining fields -->
                                            <div class="col-md-6">
                                                <div class="row g-2">
                                                    <div class="col-md-12">
                                                        {{ form.gold_karat|as_crispy_field }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="row g-2">
                                                    <div class="col-4">
                                                        {{ form.gross_weight|as_crispy_field }}
                                                    </div>
                                                    <div class="col-4">
                                                        {{ form.stone_weight|as_crispy_field }}
                                                    </div>
                                                    <div class="col-4">
                                                        {{ form.net_weight|as_crispy_field }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right column - photos, biometrics, gold items, financial details -->
                            <div class="col-md-4">
                                <!-- Biometric Authentication Section -->
                                <div class="card mb-2">
                                    <div class="card-header bg-light py-1">
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input" type="checkbox" id="enableBiometricAuth">
                                            <label class="form-check-label small" for="enableBiometricAuth">
                                                <i class="fas fa-fingerprint me-1"></i>Use Biometric Authentication
                                            </label>
                                        </div>
                                    </div>
                                    <div class="card-body p-2" id="biometricAuthSection" style="display: none;">
                                        <div id="biometricStatus"></div>
                                        <div class="text-center mb-1">
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="verifyBiometricBtn">
                                                <i class="fas fa-fingerprint me-1"></i>Verify Customer Biometric
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Customer Photo Section -->
                                <div class="card mb-2">
                                    <div class="card-header bg-light py-1">
                                        <small><strong><i class="fas fa-user-circle me-1"></i>Customer Photo</strong></small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-1">
                                            <div class="col-6">
                                                <div id="cameraView" class="border rounded" style="height: 120px; position: relative;">
                                                    <video id="cameraStream" style="width: 100%; height: 100%; object-fit: cover;" autoplay playsinline></video>
                                                    <canvas id="photoCanvas" style="display:none;"></canvas>
                                                </div>
                                                <div class="d-grid gap-1 mt-1">
                                                    <button type="button" class="btn btn-xs btn-primary" id="captureBtn">
                                                        <i class="fas fa-camera me-1"></i>Capture
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div id="photoPreview" class="border rounded d-flex align-items-center justify-content-center bg-light" style="height: 120px;">
                                                    {% if form.instance.pk and form.instance.customer_face_capture %}
                                                        <img id="capturedPhoto" class="img-fluid" style="max-height: 120px;" src="{{ form.instance.customer_face_capture }}">
                                                    {% else %}
                                                        <span id="noCaptureText" class="small text-muted">{% if form.instance.pk %}No photo{% else %}{% endif %}</span>
                                                    {% endif %}
                                                </div>
                                                <div class="d-grid gap-1 mt-1">
                                                    <button type="button" class="btn btn-xs btn-outline-secondary" id="retakeBtn">
                                                        <i class="fas fa-redo me-1"></i>Retake
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Gold Item Photos Section -->
                                <div class="card mb-2">
                                    <div class="card-header bg-light py-1 d-flex justify-content-between align-items-center">
                                        <small><strong><i class="fas fa-camera me-1"></i>Gold Item Photos</strong> <span class="badge bg-danger" id="photoCountBadge">0</span></small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-1">
                                            <div class="col-6">
                                                <div id="itemCameraView" class="border rounded" style="height: 120px; position: relative;">
                                                    <video id="itemCameraStream" style="width: 100%; height: 100%; object-fit: cover;" autoplay playsinline></video>
                                                    <canvas id="itemPhotoCanvas" style="display:none;"></canvas>
                                                </div>
                                                <div class="d-grid gap-1 mt-1">
                                                    <button type="button" class="btn btn-xs btn-primary" id="captureItemBtn">
                                                        <i class="fas fa-camera me-1"></i>Capture Item
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="border rounded p-1 bg-light position-relative" style="height: 120px; overflow-y: auto;">
                                                    <div id="noItemPhotosText" class="text-center text-muted p-1 small">
                                                        <small>No photos</small>
                                                    </div>
                                                    <div id="itemPhotosContainer" class="row g-1" {% if not form.instance.pk %}style="display: none;"{% endif %}>
                                                        {% if form.instance.pk and item_photos_list %}
                                                            {% for photo in item_photos_list %}
                                                                <div class="col-6">
                                                                    <div class="position-relative">
                                                                        <img src="{{ photo }}" class="img-thumbnail" alt="Item photo">
                                                                        <div class="bg-dark bg-opacity-50 text-white position-absolute bottom-0 start-0 end-0 small text-center">
                                                                            #{{ forloop.counter }}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </div>
                                                    <button type="button" class="btn btn-xs btn-outline-danger position-absolute bottom-0 end-0 m-1" id="clearItemPhotosBtn" {% if not form.instance.pk or not item_photos_list %}disabled{% endif %}>
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-12 pt-1">
                                                <p class="mb-0 small text-muted" style="font-size: 0.7rem;"><i class="fas fa-info-circle"></i> Take photos from different angles</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Financial Details Section - Moved below Gold Item Photos -->
                                <div class="card mb-2">
                                    <div class="card-header bg-light py-1 d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-money-bill-wave me-1"></i>Financial Details
                                        </h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                {{ form.principal_amount|as_crispy_field }}
                                            </div>
                                            <div class="col-md-6">
                                                {{ form.distribution_amount|as_crispy_field }}
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.processing_fee|as_crispy_field }}
                                            </div>
                                            <div class="col-md-8">
                                                {{ form.due_date|as_crispy_field }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button Row -->
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{% url 'loan_list' %}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-sm btn-primary" id="submitLoanBtn">
                                        <i class="fas fa-save me-1"></i>
                                        {% if form.instance.pk %}Update{% else %}Create{% endif %} Loan
                                    </button>
                                    {% if not form.instance.pk %}
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="continueIterateBtn">
                                        <i class="fas fa-plus-circle me-1"></i>Save & Create Another
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Load the loan calculator script -->
<script src="{% static 'js/loan-calculator.js' %}"></script>

<script>
    $(document).ready(function() {
        // Convert a number to words function
        function numberToWords(num) {
            if (num === 0) return 'Zero';
            
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
                'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            
            const convertLessThanOneThousand = (num) => {
                if (num === 0) return '';
                if (num < 20) return ones[num];
                
                const ten = Math.floor(num / 10);
                const unit = num % 10;
                
                return tens[ten] + (unit !== 0 ? '-' + ones[unit] : '');
            };
            
            // Handle whole numbers only
            const numStr = num.toString();
            const wholeNum = Math.round(num); // Ensure we're working with a whole number
            
            // Convert the whole number part
            const billion = Math.floor(wholeNum / 1000000000);
            const million = Math.floor((wholeNum % 1000000000) / 1000000);
            const thousand = Math.floor((wholeNum % 1000000) / 1000);
            const remainder = wholeNum % 1000;
            
            let result = '';
            
            if (billion) result += convertLessThanOneThousand(billion) + ' Billion, ';
            if (million) result += convertLessThanOneThousand(million) + ' Million, ';
            if (thousand) result += convertLessThanOneThousand(thousand) + ' Thousand, ';
            if (remainder) {
                const hundreds = Math.floor(remainder / 100);
                const tensAndUnits = remainder % 100;
                
                if (hundreds) {
                    result += ones[hundreds] + ' Hundred';
                    if (tensAndUnits) result += ' And ';
                }
                
                if (tensAndUnits) result += convertLessThanOneThousand(tensAndUnits);
            }
            
            // Clean up commas
            result = result.replace(/,\s*$/, '');
            
            return result.trim();
        }
        
        // Function to update the amount in words - modified to use local function instead of API
        function updateAmountInWords() {
            const principalAmount = parseFloat($('#id_principal_amount').val()) || 0;
            const distributionAmount = parseFloat($('#id_distribution_amount').val()) || 0;
            const processingFeeAmount = parseFloat($('#id_processing_fee').val()) || 0;
            
            // Update principal amount in words
            if (principalAmount > 0) {
                const principalWords = numberToWords(Math.round(principalAmount));
                $('#principalAmountWords').text(principalWords + ' Rupees Only');
            } else {
                $('#principalAmountWords').text('');
            }
            
            // Update distribution amount in words
            if (distributionAmount > 0) {
                const distributionWords = numberToWords(Math.round(distributionAmount));
                $('#distributionAmountWords').text(distributionWords + ' Rupees Only');
            } else {
                $('#distributionAmountWords').text('');
            }
            
            // Update processing fee in words
            if (processingFeeAmount > 0) {
                const processingFeeWords = numberToWords(Math.round(processingFeeAmount));
                $('#processingFeeWords').text(processingFeeWords + ' Rupees Only');
            } else {
                $('#processingFeeWords').text('');
            }
        }
        
        // Initial call to set amount in words on page load
        updateAmountInWords();
        
        // Add input event listener to principal and distribution amount fields
        $('#id_principal_amount, #id_distribution_amount, #id_processing_fee').on('input change', function() {
            updateAmountInWords();
        });
        
        // Add showAlert function to window object so it can be called from loan-calculator.js
        window.showAlert = function(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type || 'info'} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            
            // Add message and close button
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Add to container
            alertContainer.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => {
                        if (alertDiv.parentNode) alertDiv.parentNode.removeChild(alertDiv);
                    }, 150);
                }
            }, 5000);
        };

        // Auto-update due date and grace period when issue date changes
        $('#id_issue_date').on('change', function() {
            // Get the scheme to determine loan period
            const selectedScheme = $('#id_scheme').val();
            const issueDate = new Date($(this).val());
            
            if (issueDate && !isNaN(issueDate.getTime())) {
                // If scheme is selected, the loan-calculator.js will handle the date calculations
                if (selectedScheme) {
                    return;
                }
                
                // If no scheme is selected, use default values
                let loanPeriodMonths = 3;
                let gracePeriodDays = 30;
                
                // Calculate due date (loan period months from issue date)
                const dueDate = new Date(issueDate);
                dueDate.setMonth(dueDate.getMonth() + loanPeriodMonths);
                
                // Calculate grace period end (grace period days after due date)
                const gracePeriodEnd = new Date(dueDate);
                gracePeriodEnd.setDate(gracePeriodEnd.getDate() + gracePeriodDays);
                
                // Format dates as YYYY-MM-DD for input fields
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                // Update the due date and grace period end fields
                $('#id_due_date').val(formatDate(dueDate));
                $('#id_grace_period_end').val(formatDate(gracePeriodEnd));
                
                // Show notification that dates were updated
                showAlert('Due date and grace period end date have been automatically updated based on loan date', 'info');
            }
        });
        
        // Also update dates when scheme changes, if issue date is already set
        $('#id_scheme').on('change', function() {
            const issueDate = $('#id_issue_date').val();
            if (issueDate) {
                // Trigger the issue date change event to update due date and grace period
                $('#id_issue_date').trigger('change');
            }
        });

        // Set up customer change event to update branch field
        $('#id_customer').on('change', function() {
            const customerId = $(this).val();
            
            if (customerId) {
                // Fetch customer data to get the branch
                $.get(`/accounts/customer/${customerId}/json/`, function(data) {
                    if (data.branch_id) {
                        $('#id_branch').val(data.branch_id);
                        showAlert('Branch automatically set based on customer\'s branch', 'info');
                    }
                }).fail(function() {
                    console.error('Failed to fetch customer data');
                });
            }
        });
        
        // Initialize loan calculator
        // The calculator is automatically initialized by the loan-calculator.js file
        
        // Show the scheme-info div that's hidden by default
        $('#scheme-info').removeClass('d-none');
        
        // Camera functionality
        const cameraStream = document.getElementById('cameraStream');
        const photoCanvas = document.getElementById('photoCanvas');
        const capturedPhoto = document.getElementById('capturedPhoto') || document.createElement('img');
        capturedPhoto.id = 'capturedPhoto';
        capturedPhoto.className = 'img-fluid';
        capturedPhoto.style.maxHeight = '120px';
        capturedPhoto.style.display = 'none';
        
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const noCaptureText = document.getElementById('noCaptureText');
        const customerFaceCapture = document.getElementById('customerFaceCapture');
        const photoPreview = document.getElementById('photoPreview');
        
        // Make sure photoPreview contains capturedPhoto
        if (photoPreview && !document.getElementById('capturedPhoto')) {
            photoPreview.appendChild(capturedPhoto);
        }
        
        let stream = null;
        let cameraInitialized = false;
        
        // Initialize customer face capture from existing data if available
        {% if form.instance.customer_face_capture %}
            console.log("Initializing existing customer photo");
            if (customerFaceCapture) {
                customerFaceCapture.value = "{{ form.instance.customer_face_capture|escapejs }}";
            }
            if (capturedPhoto) {
                capturedPhoto.src = "{{ form.instance.customer_face_capture|escapejs }}";
                capturedPhoto.style.display = 'block';
                if (noCaptureText) noCaptureText.style.display = 'none';
                if (retakeBtn) retakeBtn.disabled = false;
            }
        {% endif %}
        
        // Start the camera with retry mechanism
        async function startCamera(retryCount = 0) {
            try {
                if (retryCount > 3) {
                    console.error('Failed to start camera after multiple attempts');
                    showAlert('Could not access camera. Please check camera permissions or try using a different browser.', 'danger');
                    return;
                }
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                cameraStream.srcObject = stream;
                cameraStream.onloadedmetadata = function() {
                    cameraStream.play()
                        .then(() => {
                            console.log('Camera started successfully');
                            cameraInitialized = true;
                        })
                        .catch(err => {
                            console.error('Error playing camera stream:', err);
                            // Try to recover
                            setTimeout(() => startCamera(retryCount + 1), 1000);
                        });
                };
                
            } catch (err) {
                console.error('Error accessing camera:', err);
                showAlert('Could not access camera. Please ensure you have granted camera permissions.', 'danger');
                
                // Try again with a delay
                if (retryCount < 3) {
                    console.log(`Retrying camera initialization (attempt ${retryCount + 1})...`);
                    setTimeout(() => startCamera(retryCount + 1), 1000);
                }
            }
        }
        
        // Start camera when page loads
        startCamera();
        
        // Retry button for camera access
        const addRetryButton = () => {
            const retryButton = document.createElement('button');
            retryButton.className = 'btn btn-sm btn-warning mt-1';
            retryButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Retry Camera';
            retryButton.onclick = () => {
                retryButton.disabled = true;
                retryButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Retrying...';
                startCamera();
                setTimeout(() => {
                    retryButton.disabled = false;
                    retryButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Retry Camera';
                }, 3000);
            };
            
            const cameraContainer = document.getElementById('cameraView');
            if (cameraContainer && !document.getElementById('retry-camera-btn')) {
                retryButton.id = 'retry-camera-btn';
                cameraContainer.appendChild(retryButton);
            }
        };
        
        // Add retry button after a delay if camera doesn't load
        setTimeout(() => {
            if (!cameraInitialized) {
                addRetryButton();
            }
        }, 3000);
        
        // Capture photo function
        captureBtn.addEventListener('click', function() {
            if (!cameraStream.srcObject || !cameraInitialized) {
                showAlert('Camera not ready. Please ensure camera permissions are granted and retry.', 'warning');
                addRetryButton();
                return;
            }
            
            try {
                // Set the canvas dimensions to match the video
                photoCanvas.width = cameraStream.videoWidth || 640;
                photoCanvas.height = cameraStream.videoHeight || 480;
                
                if (photoCanvas.width === 0 || photoCanvas.height === 0) {
                    console.error('Invalid canvas dimensions:', photoCanvas.width, photoCanvas.height);
                    showAlert('Cannot capture photo. Camera stream not properly initialized.', 'danger');
                    return;
                }
                
                // Draw the current video frame to the canvas
                const context = photoCanvas.getContext('2d');
                context.drawImage(cameraStream, 0, 0, photoCanvas.width, photoCanvas.height);
                
                // Convert the canvas to a data URL and display the captured photo
                const photoDataUrl = photoCanvas.toDataURL('image/jpeg');
                capturedPhoto.src = photoDataUrl;
                capturedPhoto.style.display = 'block';
                if (noCaptureText) noCaptureText.style.display = 'none';
                
                // Save the photo data in the hidden input
                customerFaceCapture.value = photoDataUrl;
                
                // Enable the retake button
                if (retakeBtn) retakeBtn.disabled = false;
                
                // Show success message
                showAlert('Customer photo captured successfully!', 'success');
            } catch (err) {
                console.error('Error capturing photo:', err);
                showAlert('Failed to capture photo. Please try again.', 'danger');
            }
        });
        
        // Retake photo function
        retakeBtn.addEventListener('click', function() {
            // Just hide the preview but don't clear the value
            capturedPhoto.style.display = 'none';
            if (noCaptureText) noCaptureText.style.display = 'block';
            
            // Important: Don't clear the customerFaceCapture value yet
            // This ensures the original photo is still submitted if no new photo is taken
            
            // Show alert that a new photo should be captured
            showAlert('Ready to capture new customer photo. Click the Capture button.', 'info');
        });
        
        // Biometric verification functionality
        const enableBiometricAuth = document.getElementById('enableBiometricAuth');
        const biometricAuthSection = document.getElementById('biometricAuthSection');
        const verifyBiometricBtn = document.getElementById('verifyBiometricBtn');
        const biometricStatus = document.getElementById('biometricStatus');
        let biometricVerified = false;
        
        // Toggle biometric authentication
        enableBiometricAuth.addEventListener('change', function() {
            if (this.checked) {
                biometricAuthSection.style.display = 'block';
            } else {
                biometricAuthSection.style.display = 'none';
                biometricVerified = true; // Skip verification if disabled
            }
        });
        
        // Biometric verification function
        verifyBiometricBtn.addEventListener('click', function() {
            const customerId = $('#id_customer').val();
            
            if (!customerId) {
                showBiometricStatus('Please select a customer first', 'warning');
                return;
            }
            
            // Simulate biometric verification (in a real app, this would call your biometric verification API)
            simulateBiometricVerification(customerId);
        });
        
        // Simulate biometric verification (replace with actual API call in production)
        function simulateBiometricVerification(customerId) {
            showBiometricStatus('Verifying biometrics...', 'info');
            
            // Simulated verification - in production, replace with actual API call
            setTimeout(function() {
                // Successfully verified (for demo)
                biometricVerified = true;
                showBiometricStatus('Biometric verification successful!', 'success');
                verifyBiometricBtn.disabled = true;
                verifyBiometricBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Verified';
                verifyBiometricBtn.classList.remove('btn-outline-primary');
                verifyBiometricBtn.classList.add('btn-success');
            }, 1500);
        }
        
        // Display biometric status
        function showBiometricStatus(message, type) {
            biometricStatus.innerHTML = `<div class="alert alert-${type} mb-3">${message}</div>`;
        }
        
        // Function to display alert message
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Use the dedicated alert container added in the HTML
            let alertContainer = document.getElementById('alertContainer');
            
            // Add the alert to the container
            alertContainer.appendChild(alertDiv);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    if (alertDiv.parentNode === alertContainer) {
                        alertContainer.removeChild(alertDiv);
                    }
                }, 150);
            }, 5000);
        }

        // Gold Item Photo Capture Functionality
        const itemCameraStream = document.getElementById('itemCameraStream');
        const itemPhotoCanvas = document.getElementById('itemPhotoCanvas');
        const captureItemBtn = document.getElementById('captureItemBtn');
        const itemPhotosContainer = document.getElementById('itemPhotosContainer');
        const noItemPhotosText = document.getElementById('noItemPhotosText') || document.createElement('div');
        const clearItemPhotosBtn = document.getElementById('clearItemPhotosBtn') || document.createElement('button');
        const photoCountBadge = document.getElementById('photoCountBadge');
        const itemPhotosData = document.getElementById('itemPhotosData');
        let itemStream = null;
        let itemPhotos = [];
        
        // Initialize item photos from existing data if available
        {% if item_photos_list %}
            console.log("Initializing existing item photos");
            
            try {
                {% for photo in item_photos_list %}
                    itemPhotos.push({
                        id: 'existing-item-photo-{{ forloop.counter }}',
                        dataUrl: '{{ photo|escapejs }}'
                    });
                {% endfor %}
                
                // Update the hidden input with the existing photos
                updateItemPhotosData();
                
                // Update the display
                if (itemPhotos.length > 0 && noItemPhotosText) {
                    noItemPhotosText.style.display = 'none';
                }
                
                if (clearItemPhotosBtn) {
                    clearItemPhotosBtn.disabled = false;
                }
                
                // Update the photo count badge
                if (photoCountBadge) {
                    photoCountBadge.textContent = `${itemPhotos.length} Photos`;
                    photoCountBadge.className = 'badge me-2 ' + 
                        (itemPhotos.length < 2 ? 'bg-danger' : 'bg-success');
                }
            } catch (error) {
                console.error("Error initializing item photos:", error);
            }
        {% endif %}
        
        // Start the item camera
        async function startItemCamera() {
            try {
                itemStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'environment' // Use back camera if available
                    }
                });
                itemCameraStream.srcObject = itemStream;
            } catch (err) {
                console.error('Error accessing camera for item photos:', err);
                showAlert('Could not access camera for item photos. Please check camera permissions.', 'danger');
            }
        }
        
        // Start item camera when page loads
        startItemCamera();
        
        // Capture item photo function
        captureItemBtn.addEventListener('click', function() {
            // Set the canvas dimensions to match the video
            itemPhotoCanvas.width = itemCameraStream.videoWidth;
            itemPhotoCanvas.height = itemCameraStream.videoHeight;
            
            // Draw the current video frame to the canvas
            const context = itemPhotoCanvas.getContext('2d');
            context.drawImage(itemCameraStream, 0, 0, itemPhotoCanvas.width, itemPhotoCanvas.height);
            
            // Convert the canvas to a data URL
            const photoDataUrl = itemPhotoCanvas.toDataURL('image/jpeg');
            
            // Add the photo to the collection
            addItemPhoto(photoDataUrl);
            
            // Update the photos data in the hidden input
            updateItemPhotosData();
            
            // Enable the clear button
            if (clearItemPhotosBtn) clearItemPhotosBtn.disabled = false;

            // Show success message without affecting the photos
            showAlert('Item photo captured successfully!', 'success');
        });
        
        // Add an item photo to the collection
        function addItemPhoto(photoDataUrl) {
            const photoId = 'item-photo-' + Date.now();
            itemPhotos.push({ id: photoId, dataUrl: photoDataUrl });
            
            // Hide the "no photos" text if this is the first photo
            if (itemPhotos.length === 1 && noItemPhotosText) {
                noItemPhotosText.style.display = 'none';
            }
            
            // Ensure the photos container is visible
            if (itemPhotosContainer) {
                itemPhotosContainer.style.display = 'flex';
    
                // Create a thumbnail element
                const thumbnailCol = document.createElement('div');
                thumbnailCol.className = 'col-6';
                thumbnailCol.innerHTML = `
                    <div class="position-relative">
                        <img src="${photoDataUrl}" class="img-thumbnail" alt="Item photo ${itemPhotos.length}">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 delete-photo" data-photo-id="${photoId}">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="bg-dark bg-opacity-50 text-white position-absolute bottom-0 start-0 end-0 small text-center">
                            Photo ${itemPhotos.length}
                        </div>
                    </div>
                `;
                itemPhotosContainer.appendChild(thumbnailCol);
                
                // Add event listener to delete button
                const deleteBtn = thumbnailCol.querySelector('.delete-photo');
                deleteBtn.addEventListener('click', function() {
                    const photoId = this.getAttribute('data-photo-id');
                    deleteItemPhoto(photoId, this.closest('.col-6'));
                });
            }
            
            // Update the photo count badge
            updatePhotoCountBadge();
        }
        
        // Delete an item photo
        function deleteItemPhoto(photoId, element) {
            // Remove from the DOM
            element.remove();
            
            // Remove from the array
            itemPhotos = itemPhotos.filter(photo => photo.id !== photoId);
            
            // Show the "no photos" text if this was the last photo
            if (itemPhotos.length === 0 && noItemPhotosText) {
                noItemPhotosText.style.display = 'block';
                if (clearItemPhotosBtn) clearItemPhotosBtn.disabled = true;
            }
            
            // Update the photos data in the hidden input
            updateItemPhotosData();
            
            // Update the photo count badge
            updatePhotoCountBadge();
        }
        
        // Update the item photos data in the hidden input
        function updateItemPhotosData() {
            // Store only the data URLs to save space
            const dataUrls = itemPhotos.map(photo => photo.dataUrl);
            itemPhotosData.value = JSON.stringify(dataUrls);
        }
        
        // Update the photo count badge
        function updatePhotoCountBadge() {
            if (photoCountBadge) {
                photoCountBadge.textContent = `${itemPhotos.length} Photos`;
                photoCountBadge.className = 'badge me-2 ' + 
                    (itemPhotos.length < 2 ? 'bg-danger' : 'bg-success');
            }
        }
        
        // Clear all item photos
        if (clearItemPhotosBtn) {
            clearItemPhotosBtn.addEventListener('click', function() {
                // Confirm before clearing
                if (confirm('Are you sure you want to clear all item photos?')) {
                    // Clear the photos container
                    if (itemPhotosContainer) itemPhotosContainer.innerHTML = '';
                    
                    // Reset the photos array
                    itemPhotos = [];
                    
                    // Show the "no photos" text
                    if (noItemPhotosText) noItemPhotosText.style.display = 'block';
                    
                    // Clear the hidden input
                    itemPhotosData.value = '';
                    
                    // Disable the clear button
                    clearItemPhotosBtn.disabled = true;
                    
                    // Update the photo count badge
                    updatePhotoCountBadge();
                }
            });
        }
        
        // Calculate and display Total Items count from item name
        function updateTotalItemsCount() {
            // Show the total items section by default
            $('#totalItemsDisplay').show();
            
            const itemName = $('#id_item_name').val() || '';
            let totalItems = 0;
            
            // Pattern to match formats like "ring-6" or "earrings-2" or "ring - 6"
            // Improved regex to handle spaces around the dash
            const pattern = /(\w+)\s*-\s*(\d+)/g;
            let match;
            let itemsFound = false;
            
            // Find all matches in the item name
            while ((match = pattern.exec(itemName)) !== null) {
                const count = parseInt(match[2], 10);
                if (!isNaN(count)) {
                    totalItems += count;
                    itemsFound = true;
                }
            }
            
            // If no pattern matches found, check if we have a non-empty item name
            if (!itemsFound && itemName.trim() !== '') {
                // Default to 1 if there's an item name but no count pattern
                totalItems = 1;
            }
            
            // Update the field with the calculated value
            $('#calculatedTotalItems').val(totalItems);
            
            return totalItems;
        }
        
        // Set initial value and attach event listener
        setTimeout(updateTotalItemsCount, 100); // Add delay to ensure DOM is ready
        $('#id_item_name').on('input', updateTotalItemsCount);

        // Original loan form JS code
        const KARAT_PURITY = {
            '24': 0.999,
            '22': 0.916,
            '21': 0.875,
            '20': 0.833,
            '18': 0.750,
            '14': 0.583
        };

        // Debounce function to prevent multiple rapid updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            }
        }

        // Calculate net weight when gross weight or stone weight changes
        const calculateNetWeight = function() {
            const grossWeight = parseFloat($('#id_gross_weight').val()) || 0;
            const stoneWeight = parseFloat($('#id_stone_weight').val()) || 0;
            const netWeight = Math.max(0, grossWeight - stoneWeight);
            $('#id_net_weight').val(netWeight.toFixed(3));
            
            // Auto-recalculate principal amount whenever net weight changes
            calculateGoldValue();
        };

        // Function to clean numeric input
        function cleanNumericInput(value) {
            // Remove all non-numeric characters except decimal point
            return value.replace(/[^0-9.]/g, '');
        }

        // Format number inputs to handle string values
        $('#id_market_price_22k, #id_principal_amount').on('input', function() {
            const cleanedValue = cleanNumericInput($(this).val());
            $(this).val(cleanedValue);
        });

        // Calculate gold value and suggest principal amount
        const calculateGoldValue = debounce(function() {
            const marketPriceStr = cleanNumericInput($('#id_market_price_22k').val());
            const marketPrice = parseFloat(marketPriceStr) || 0;
            const selectedKarat = $('#id_gold_karat').val();
            const netWeight = parseFloat($('#id_net_weight').val()) || 0;
            
            // Remove any existing suggestion messages
            $('.gold-value-message').remove();
            
            if (marketPrice && selectedKarat && netWeight > 0) {
                const purityRatio = KARAT_PURITY[selectedKarat] / KARAT_PURITY['22'];
                const goldValue = marketPrice * netWeight * purityRatio;
                
                // Calculate standard principal (75% of gold value)
                const standardPrincipal = goldValue * 0.75;
                
                // Round to nearest multiple of 500
                let suggestedPrincipal = Math.round(standardPrincipal / 500) * 500;
                
                // Calculate minimum (73%) and maximum (78%) allowed values
                const minPrincipal = goldValue * 0.73;
                const maxPrincipal = goldValue * 0.78;
                
                // Ensure the rounded amount stays between 73% and 78%
                if (suggestedPrincipal < minPrincipal) {
                    suggestedPrincipal = Math.ceil(minPrincipal / 500) * 500;
                } else if (suggestedPrincipal > maxPrincipal) {
                    suggestedPrincipal = Math.floor(maxPrincipal / 500) * 500;
                }

                // Set the suggested principal amount
                $('#id_principal_amount').val(suggestedPrincipal);
                
                // Trigger the distribution amount calculation
                calculateDistributionAmount();
                
                // Add info message about the suggested principal amount
                const message = $('<div class="gold-value-message text-info small mt-1"></div>')
                    .text(`Suggested loan amount based on gold value: ${suggestedPrincipal.toLocaleString('en-IN')}`);
                message.insertAfter('#div_id_principal_amount .form-text');
            }
        }, 300);

        // Calculate distribution amount when principal changes
        const calculateDistributionAmount = function() {
            const principalStr = cleanNumericInput($('#id_principal_amount').val());
            const principal = Math.round(parseFloat(principalStr)) || 0;
            
            // Calculate processing fee as 1% of principal amount, rounded to nearest integer
            const processingFeeAmount = Math.round(principal * 0.01);
            
            // Set the processing fee amount as an integer
            $('#id_processing_fee').val(Math.round(processingFeeAmount));
            
            // Calculate and set distribution amount as integer
            const distributionAmount = principal - processingFeeAmount;
            $('#id_distribution_amount').val(Math.round(distributionAmount));

            // Update amounts in words directly using our local function
            updateAmountInWords();
        };

        // Set up event handlers
        $('#id_gross_weight, #id_stone_weight').on('input', calculateNetWeight);
        $('#id_market_price_22k, #id_gold_karat, #id_net_weight').on('input', calculateGoldValue);
        $('#id_principal_amount')
            .on('input', calculateDistributionAmount)
            .trigger('input'); // Trigger on page load to calculate processing fee

        // Also calculate processing fee when page loads if principal amount is already set
        $(document).ready(function() {
            if ($('#id_principal_amount').val()) {
                calculateDistributionAmount();
                updateAmountInWords(); // Explicitly call to update all word displays
            }
            
            // Make sure processing fee is displayed in words when it changes
            $('#id_processing_fee').on('change input', function() {
                const amount = parseFloat($(this).val()) || 0;
                const processingFeeWords = numberToWords(Math.round(amount));
                $('#processingFeeWords').text(processingFeeWords + ' Rupees Only');
            });
            
            // Trigger processing fee word update on page load
            if ($('#id_processing_fee').val()) {
                const amount = parseFloat($('#id_processing_fee').val()) || 0;
                const processingFeeWords = numberToWords(Math.round(amount));
                $('#processingFeeWords').text(processingFeeWords + ' Rupees Only');
            }
        });
        
        // Validate principal amount against min/max
        $('#id_principal_amount').on('change', function() {
            const marketPrice = parseFloat($('#id_market_price_22k').val()) || 0;
            const selectedKarat = $('#id_gold_karat').val();
            const netWeight = parseFloat($('#id_net_weight').val()) || 0;
            const principal = parseFloat($(this).val()) || 0;
            
            // Remove any existing error messages
            $('.principal-error').remove();
            
            if (marketPrice && selectedKarat && netWeight > 0) {
                const purityRatio = KARAT_PURITY[selectedKarat] / KARAT_PURITY['22'];
                const goldValue = marketPrice * netWeight * purityRatio;
                const minPrincipal = Math.round(goldValue * 0.5);
                const maxPrincipal = Math.round(goldValue * 0.85);
                
                if (principal < minPrincipal || principal > maxPrincipal) {
                    const errorMsg = $('<div class="principal-error text-danger small mt-1"></div>')
                        .text(principal < minPrincipal 
                            ? `Principal must be at least ${minPrincipal} (50% of gold value)`
                            : `Principal cannot exceed ${maxPrincipal} (85% of gold value)`);
                    errorMsg.insertAfter('#div_id_principal_amount .form-text');
                }
            }
            
            // Update amount in words
            updateAmountInWords();
        });

        // Update amount in words when distribution amount changes
        $('#id_distribution_amount').on('change', function() {
            updateAmountInWords();
        });

        // Add containers for the amount in words
        $('#div_id_principal_amount').append('<small id="principalAmountWords" class="text-muted d-block mt-1"></small>');
        $('#div_id_distribution_amount').append('<small id="distributionAmountWords" class="text-muted d-block mt-1" style="font-size: 0.65rem;"></small>');
        $('#div_id_processing_fee').append('<small id="processingFeeWords" class="text-muted d-block mt-1" style="font-size: 0.65rem;"></small>');
        
        // Function to calculate and update the total items count
        function updateTotalItems() {
            let total = 0;
            
            // Count all rows in the gold items table
            $('#goldItems tbody tr').each(function() {
                // Only count rows that have values (not empty rows)
                const weightValue = $(this).find('input[name$="-weight"]').val();
                if (weightValue && parseFloat(weightValue) > 0) {
                    total += 1;
                }
            });
            
            // Update the total items display
            $('#calculatedTotalItems').val(total);
        }
        
        // Call updateTotalItems whenever gold items are added, removed or changed
        $(document).on('change', '#goldItems input', updateTotalItems);
        $(document).on('click', '.add-form-row, .remove-form-row', function() {
            // Use setTimeout to ensure the DOM is updated before counting
            setTimeout(updateTotalItems, 100);
        });
        
        // Initial calculation when page loads
        $(document).ready(function() {
            updateTotalItems();
        });
    });
</script>
{% endblock %}