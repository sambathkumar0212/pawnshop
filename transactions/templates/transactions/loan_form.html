{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit Loan{% else %}New Loan{% endif %} - Pawnshop Management{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="fas fa-hand-holding-usd me-2"></i>
                    {% if form.instance.pk %}Edit Loan{% else %}New Loan{% endif %}
                </h2>
                <a href="{% url 'loan_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Loans
                </a>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-body">
                    <form method="post" id="loanForm" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="customer_face_capture" id="customerFaceCapture" value="">
                        <input type="hidden" name="item_photos" id="itemPhotosData" value="">
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-user me-2"></i>Customer & Authentication
                                </h5>
                            </div>
                            <div class="col-md-8">
                                {{ form.customer|as_crispy_field }}
                                
                                <!-- Biometric Authentication Section -->
                                <div class="card mt-3">
                                    <div class="card-header bg-light">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableBiometricAuth">
                                            <label class="form-check-label" for="enableBiometricAuth">
                                                <i class="fas fa-fingerprint me-2"></i>Use Biometric Authentication
                                            </label>
                                        </div>
                                    </div>
                                    <div class="card-body" id="biometricAuthSection" style="display: none;">
                                        <div id="biometricStatus"></div>
                                        <div class="text-center mb-2">
                                            <button type="button" class="btn btn-outline-primary" id="verifyBiometricBtn">
                                                <i class="fas fa-fingerprint me-2"></i>Verify Customer Biometric
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                {{ form.branch|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-camera me-2"></i>Customer Photo
                                </h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div id="cameraView" class="border rounded mb-2" style="height: 240px; position: relative;">
                                                    <video id="cameraStream" style="width: 100%; height: 100%; object-fit: cover;" autoplay playsinline></video>
                                                    <canvas id="photoCanvas" style="display:none;"></canvas>
                                                </div>
                                                <div class="d-flex justify-content-center mb-3">
                                                    <button type="button" class="btn btn-primary" id="captureBtn">
                                                        <i class="fas fa-camera me-2"></i>Capture Photo
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div id="photoPreview" class="border rounded mb-2 d-flex align-items-center justify-content-center bg-light" style="height: 240px;">
                                                    <span id="noCaptureText">No photo captured</span>
                                                    <img id="capturedPhoto" class="img-fluid" style="max-height: 240px; display: none;">
                                                </div>
                                                <div class="d-flex justify-content-center">
                                                    <button type="button" class="btn btn-outline-secondary" id="retakeBtn" disabled>
                                                        <i class="fas fa-redo me-2"></i>Retake Photo
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-box me-2"></i>Item Information
                                </h5>
                            </div>
                            
                            <div class="col-12">
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ form.item_name|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.item_category|as_crispy_field }}
                                    </div>
                                    <div class="col-12">
                                        {{ form.item_description|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.market_price_22k|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.gold_karat|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.gross_weight|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.stone_weight|as_crispy_field }}
                                    </div>
                                    <div class="col-12">
                                        {{ form.net_weight|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gold Item Photos Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-images me-2"></i>Gold Item Photos
                                </h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div id="itemCameraView" class="border rounded mb-2" style="height: 240px; position: relative;">
                                                    <video id="itemCameraStream" style="width: 100%; height: 100%; object-fit: cover;" autoplay playsinline></video>
                                                    <canvas id="itemPhotoCanvas" style="display:none;"></canvas>
                                                </div>
                                                <div class="d-flex justify-content-center mb-3">
                                                    <button type="button" class="btn btn-primary" id="captureItemBtn">
                                                        <i class="fas fa-camera me-2"></i>Capture Item Photo
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="border rounded p-2 mb-3 bg-light" style="height: 240px; overflow-y: auto;">
                                                    <div id="noItemPhotosText" class="text-center text-muted p-5">
                                                        No item photos captured yet.<br>
                                                        <small>Take at least 2 photos from different angles</small>
                                                    </div>
                                                    <div id="itemPhotosContainer" class="row g-2"></div>
                                                </div>
                                                <div class="d-flex justify-content-center">
                                                    <span class="badge bg-primary me-2" id="photoCountBadge">0 Photos</span>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" id="clearItemPhotosBtn" disabled>
                                                        <i class="fas fa-trash-alt me-1"></i>Clear All
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3 small text-muted">
                                            <ul>
                                                <li>Take multiple photos from different angles</li>
                                                <li>Ensure good lighting to capture details</li>
                                                <li>Include photos of maker's marks, hallmarks or certificates if available</li>
                                                <li>At least 2 photos are required</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-money-bill-wave me-2"></i>Loan Details
                                </h5>
                            </div>
                            <div class="col-md-6">
                                {{ form.principal_amount|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.processing_fee|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.distribution_amount|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.interest_rate|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-calendar me-2"></i>Dates
                                </h5>
                            </div>
                            <div class="col-md-4">
                                {{ form.issue_date|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.due_date|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.grace_period_end|as_crispy_field }}
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'loan_list' %}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitLoanBtn">
                                <i class="fas fa-save me-2"></i>
                                {% if form.instance.pk %}Update{% else %}Create{% endif %} Loan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        // Camera functionality
        const cameraStream = document.getElementById('cameraStream');
        const photoCanvas = document.getElementById('photoCanvas');
        const capturedPhoto = document.getElementById('capturedPhoto');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const noCaptureText = document.getElementById('noCaptureText');
        const customerFaceCapture = document.getElementById('customerFaceCapture');
        let stream = null;
        
        // Start the camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                cameraStream.srcObject = stream;
            } catch (err) {
                console.error('Error accessing camera:', err);
                showAlert('Could not access camera. Please check camera permissions.', 'danger');
            }
        }
        
        // Start camera when page loads
        startCamera();
        
        // Capture photo function
        captureBtn.addEventListener('click', function() {
            // Set the canvas dimensions to match the video
            photoCanvas.width = cameraStream.videoWidth;
            photoCanvas.height = cameraStream.videoHeight;
            
            // Draw the current video frame to the canvas
            const context = photoCanvas.getContext('2d');
            context.drawImage(cameraStream, 0, 0, photoCanvas.width, photoCanvas.height);
            
            // Convert the canvas to a data URL and display the captured photo
            const photoDataUrl = photoCanvas.toDataURL('image/jpeg');
            capturedPhoto.src = photoDataUrl;
            capturedPhoto.style.display = 'block';
            noCaptureText.style.display = 'none';
            
            // Save the photo data in the hidden input
            customerFaceCapture.value = photoDataUrl;
            
            // Enable the retake button
            retakeBtn.disabled = false;
        });
        
        // Retake photo function
        retakeBtn.addEventListener('click', function() {
            // Clear the captured photo
            capturedPhoto.style.display = 'none';
            noCaptureText.style.display = 'block';
            customerFaceCapture.value = '';
            retakeBtn.disabled = true;
        });
        
        // Biometric verification functionality
        const enableBiometricAuth = document.getElementById('enableBiometricAuth');
        const biometricAuthSection = document.getElementById('biometricAuthSection');
        const verifyBiometricBtn = document.getElementById('verifyBiometricBtn');
        const biometricStatus = document.getElementById('biometricStatus');
        let biometricVerified = false;
        
        // Toggle biometric authentication
        enableBiometricAuth.addEventListener('change', function() {
            if (this.checked) {
                biometricAuthSection.style.display = 'block';
            } else {
                biometricAuthSection.style.display = 'none';
                biometricVerified = true; // Skip verification if disabled
            }
        });
        
        // Biometric verification function
        verifyBiometricBtn.addEventListener('click', function() {
            const customerId = $('#id_customer').val();
            
            if (!customerId) {
                showBiometricStatus('Please select a customer first', 'warning');
                return;
            }
            
            // Simulate biometric verification (in a real app, this would call your biometric verification API)
            simulateBiometricVerification(customerId);
        });
        
        // Simulate biometric verification (replace with actual API call in production)
        function simulateBiometricVerification(customerId) {
            showBiometricStatus('Verifying biometrics...', 'info');
            
            // Simulated verification - in production, replace with actual API call
            setTimeout(function() {
                // Successfully verified (for demo)
                biometricVerified = true;
                showBiometricStatus('Biometric verification successful!', 'success');
                verifyBiometricBtn.disabled = true;
                verifyBiometricBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Verified';
                verifyBiometricBtn.classList.remove('btn-outline-primary');
                verifyBiometricBtn.classList.add('btn-success');
            }, 1500);
            
            // In production, you'd make an AJAX request to verify biometrics:
            /*
            $.ajax({
                url: '/api/verify-biometric/',
                type: 'POST',
                data: {
                    'customer_id': customerId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.verified) {
                        biometricVerified = true;
                        showBiometricStatus('Biometric verification successful!', 'success');
                    } else {
                        showBiometricStatus('Biometric verification failed: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, textStatus, errorThrown) {
                    showBiometricStatus('Error: ' + errorThrown, 'danger');
                }
            });
            */
        }
        
        // Display biometric status
        function showBiometricStatus(message, type) {
            biometricStatus.innerHTML = `<div class="alert alert-${type} mb-3">${message}</div>`;
        }
        
        // Gold Item Photo Capture Functionality
        const itemCameraStream = document.getElementById('itemCameraStream');
        const itemPhotoCanvas = document.getElementById('itemPhotoCanvas');
        const captureItemBtn = document.getElementById('captureItemBtn');
        const itemPhotosContainer = document.getElementById('itemPhotosContainer');
        const noItemPhotosText = document.getElementById('noItemPhotosText');
        const clearItemPhotosBtn = document.getElementById('clearItemPhotosBtn');
        const photoCountBadge = document.getElementById('photoCountBadge');
        const itemPhotosData = document.getElementById('itemPhotosData');
        let itemStream = null;
        let itemPhotos = [];
        
        // Start the item camera
        async function startItemCamera() {
            try {
                itemStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'environment' // Use back camera if available
                    }
                });
                itemCameraStream.srcObject = itemStream;
            } catch (err) {
                console.error('Error accessing camera for item photos:', err);
                showAlert('Could not access camera for item photos. Please check camera permissions.', 'danger');
            }
        }
        
        // Start item camera when page loads
        startItemCamera();
        
        // Capture item photo function
        captureItemBtn.addEventListener('click', function() {
            // Set the canvas dimensions to match the video
            itemPhotoCanvas.width = itemCameraStream.videoWidth;
            itemPhotoCanvas.height = itemCameraStream.videoHeight;
            
            // Draw the current video frame to the canvas
            const context = itemPhotoCanvas.getContext('2d');
            context.drawImage(itemCameraStream, 0, 0, itemPhotoCanvas.width, itemPhotoCanvas.height);
            
            // Convert the canvas to a data URL
            const photoDataUrl = itemPhotoCanvas.toDataURL('image/jpeg');
            
            // Add the photo to the collection
            addItemPhoto(photoDataUrl);
            
            // Update the photos data in the hidden input
            updateItemPhotosData();
            
            // Enable the clear button
            clearItemPhotosBtn.disabled = false;
        });
        
        // Add an item photo to the collection
        function addItemPhoto(photoDataUrl) {
            const photoId = 'item-photo-' + Date.now();
            itemPhotos.push({ id: photoId, dataUrl: photoDataUrl });
            
            // Hide the "no photos" text if this is the first photo
            if (itemPhotos.length === 1) {
                noItemPhotosText.style.display = 'none';
            }
            
            // Create a thumbnail element
            const thumbnailCol = document.createElement('div');
            thumbnailCol.className = 'col-6';
            thumbnailCol.innerHTML = `
                <div class="position-relative">
                    <img src="${photoDataUrl}" class="img-thumbnail" alt="Item photo ${itemPhotos.length}">
                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 delete-photo" data-photo-id="${photoId}">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="bg-dark bg-opacity-50 text-white position-absolute bottom-0 start-0 end-0 small text-center">
                        Photo ${itemPhotos.length}
                    </div>
                </div>
            `;
            itemPhotosContainer.appendChild(thumbnailCol);
            
            // Add event listener to delete button
            const deleteBtn = thumbnailCol.querySelector('.delete-photo');
            deleteBtn.addEventListener('click', function() {
                const photoId = this.getAttribute('data-photo-id');
                deleteItemPhoto(photoId, this.closest('.col-6'));
            });
            
            // Update the photo count badge
            updatePhotoCountBadge();
        }
        
        // Delete an item photo
        function deleteItemPhoto(photoId, element) {
            // Remove from the DOM
            element.remove();
            
            // Remove from the array
            itemPhotos = itemPhotos.filter(photo => photo.id !== photoId);
            
            // Show the "no photos" text if this was the last photo
            if (itemPhotos.length === 0) {
                noItemPhotosText.style.display = 'block';
                clearItemPhotosBtn.disabled = true;
            }
            
            // Update the photos data in the hidden input
            updateItemPhotosData();
            
            // Update the photo count badge
            updatePhotoCountBadge();
        }
        
        // Update the item photos data in the hidden input
        function updateItemPhotosData() {
            // Store only the data URLs to save space
            const dataUrls = itemPhotos.map(photo => photo.dataUrl);
            itemPhotosData.value = JSON.stringify(dataUrls);
        }
        
        // Update the photo count badge
        function updatePhotoCountBadge() {
            photoCountBadge.textContent = `${itemPhotos.length} Photos`;
            photoCountBadge.className = 'badge me-2 ' + 
                (itemPhotos.length < 2 ? 'bg-danger' : 'bg-success');
        }
        
        // Clear all item photos
        clearItemPhotosBtn.addEventListener('click', function() {
            // Confirm before clearing
            if (confirm('Are you sure you want to clear all item photos?')) {
                // Clear the photos container
                itemPhotosContainer.innerHTML = '';
                
                // Reset the photos array
                itemPhotos = [];
                
                // Show the "no photos" text
                noItemPhotosText.style.display = 'block';
                
                // Clear the hidden input
                itemPhotosData.value = '';
                
                // Disable the clear button
                clearItemPhotosBtn.disabled = true;
                
                // Update the photo count badge
                updatePhotoCountBadge();
            }
        });
        
        // Form validation before submit
        $('#loanForm').on('submit', function(e) {
            // Check customer photo capture
            if (!customerFaceCapture.value) {
                e.preventDefault();
                showAlert('Please capture a customer photo before proceeding', 'warning');
                return false;
            }
            
            // Check biometric verification if enabled
            if (enableBiometricAuth.checked && !biometricVerified) {
                e.preventDefault();
                showAlert('Please complete biometric verification before proceeding', 'warning');
                return false;
            }
            
            // Check if at least 2 item photos were captured
            if (itemPhotos.length < 2) {
                e.preventDefault();
                showAlert('Please capture at least 2 photos of the gold item from different angles', 'warning');
                return false;
            }
        });
        
        // Display alerts
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            // Insert the alert at the top of the form
            $('#loanForm').prepend(alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }

        // Original loan form JS code
        const KARAT_PURITY = {
            '24': 0.999,
            '22': 0.916,
            '21': 0.875,
            '20': 0.833,
            '18': 0.750,
            '14': 0.583
        };

        // Debounce function to prevent multiple rapid updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Calculate net weight when gross weight or stone weight changes
        const calculateNetWeight = function() {
            const grossWeight = parseFloat($('#id_gross_weight').val()) || 0;
            const stoneWeight = parseFloat($('#id_stone_weight').val()) || 0;
            const netWeight = Math.max(0, grossWeight - stoneWeight);
            $('#id_net_weight').val(netWeight.toFixed(3));
            
            // Calculate and set principal amount automatically
            const marketPrice = parseFloat($('#id_market_price_22k').val()) || 0;
            const selectedKarat = $('#id_gold_karat').val();
            if (marketPrice && selectedKarat && netWeight) {
                const purityRatio = KARAT_PURITY[selectedKarat] / KARAT_PURITY['22'];
                const goldValue = marketPrice * netWeight * purityRatio;
                const suggestedPrincipal = goldValue * 0.75; // Set to 75% of gold value
                $('#id_principal_amount').val(suggestedPrincipal.toFixed(2)).trigger('input');
                
                // Show notification message
                const messageDiv = $('<div class="alert alert-info mt-2" role="alert">')
                    .text('Principal amount has been automatically set to 75% of the gold value.')
                    .insertAfter('#id_principal_amount');
                    
                // Remove the message after 3 seconds
                setTimeout(() => {
                    messageDiv.fadeOut('slow', function() {
                        $(this).remove();
                    });
                }, 3000);
            }
        };

        // Function to update principal amount message
        const updatePrincipalMessage = debounce(function() {
            const marketPrice = parseFloat($('#id_market_price_22k').val()) || 0;
            const selectedKarat = $('#id_gold_karat').val();
            const netWeight = parseFloat($('#id_net_weight').val()) || 0;
            const principalField = $('#id_principal_amount');
            const principalGroup = principalField.closest('.form-group');
            const currentPrincipal = parseFloat(principalField.val()) || 0;
            
            // Remove existing messages
            $('.principal-message').remove();

            // Create new message container
            const messageDiv = $('<div class="principal-message text-muted small"></div>');
            principalField.after(messageDiv);

            if (marketPrice && selectedKarat && netWeight) {
                const purityRatio = KARAT_PURITY[selectedKarat] / KARAT_PURITY['22'];
                const goldValue = marketPrice * netWeight * purityRatio;
                const maxPrincipal = goldValue * 0.85;
                const minPrincipal = goldValue * 0.50;

                // Always show the allowed range
                messageDiv.html(`<i class="fas fa-info-circle"></i> Allowed principal range: ₹${minPrincipal.toFixed(2)} (50%) to ₹${maxPrincipal.toFixed(2)} (85%)`);

                // Update field constraints
                principalField
                    .attr('min', minPrincipal)
                    .attr('max', maxPrincipal)
                    .attr('data-min-value', minPrincipal)
                    .attr('data-max-value', maxPrincipal);

                // Add validation message if needed
                if (currentPrincipal && (currentPrincipal < minPrincipal || currentPrincipal > maxPrincipal)) {
                    principalField.addClass('is-invalid');
                    $('<div class="invalid-feedback"></div>')
                        .text(currentPrincipal > maxPrincipal 
                            ? `Principal amount cannot exceed ₹${maxPrincipal.toFixed(2)}`
                            : `Principal amount must be at least ₹${minPrincipal.toFixed(2)}`)
                        .insertAfter(messageDiv);
                } else {
                    principalField.removeClass('is-invalid');
                }
            }
        }, 250); // 250ms debounce

        // Calculate distribution amount when principal or processing fee changes
        const calculateDistributionAmount = function() {
            const principal = parseFloat($('#id_principal_amount').val()) || 0;
            // Calculate processing fee as 1% of principal amount
            const processingFeePercentage = 0.01; // Fixed at 1%
            const processingFeeAmount = principal * processingFeePercentage;
            
            // Display the processing fee amount instead of percentage
            $('#id_processing_fee')
                .val(processingFeeAmount.toFixed(2))
                .prop('readonly', true);
            
            const distributionAmount = principal - processingFeeAmount;
            
            $('#id_distribution_amount')
                .val(distributionAmount.toFixed(2))
                .prop('readonly', true);
        };

        // Set up event handlers
        $('#id_gross_weight, #id_stone_weight').on('input', calculateNetWeight);
        $('#id_market_price_22k, #id_gold_karat, #id_net_weight').on('input', function() {
            calculateNetWeight();
            updatePrincipalMessage();
        });
        $('#id_principal_amount')
            .on('input', function() {
                calculateDistributionAmount();
                updatePrincipalMessage();
            })
            .trigger('input'); // Trigger on page load

        // Calculate due date when issue date changes
        const calculateDueDate = function() {
            const issueDate = new Date($('#id_issue_date').val());
            if (issueDate) {
                const dueDate = new Date(issueDate);
                dueDate.setDate(dueDate.getDate() + 364);
                $('#id_due_date').val(dueDate.toISOString().split('T')[0]);
            }
        };

        // Set up issue date change handler
        $('#id_issue_date').on('change', calculateDueDate);
        if ($('#id_issue_date').val()) {
            calculateDueDate();
        }

        // Calculate grace period end when due date changes
        const calculateGracePeriod = function() {
            const dueDate = new Date($('#id_due_date').val());
            if (dueDate) {
                const gracePeriodEnd = new Date(dueDate);
                gracePeriodEnd.setDate(gracePeriodEnd.getDate() + 6);
                $('#id_grace_period_end').val(gracePeriodEnd.toISOString().split('T')[0]);
            }
        };

        // Set up due date change handler
        $('#id_due_date').on('change', calculateGracePeriod);
        if ($('#id_due_date').val()) {
            calculateGracePeriod();
        }

        // Initial calculations
        calculateNetWeight();
        updatePrincipalMessage();
        calculateDistributionAmount();
        
        // Clean up when leaving the page
        $(window).on('beforeunload', function() {
            // Stop the camera streams if they exist
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (itemStream) {
                itemStream.getTracks().forEach(track => track.stop());
            }
        });
    });
</script>
{% endblock %}