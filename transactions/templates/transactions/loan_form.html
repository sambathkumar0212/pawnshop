{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit Loan{% else %}New Loan{% endif %} - Pawnshop Management{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="fas fa-hand-holding-usd me-2"></i>
                    {% if form.instance.pk %}Edit Loan{% else %}New Loan{% endif %}
                </h2>
                <a href="{% url 'loan_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Loans
                </a>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-body">
                    <!-- Add debugging information and error messages at the top of the form -->
                    {% if messages %}
                    <div class="mb-4">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger mb-4">
                        <h5 class="alert-heading">Please correct the following errors:</h5>
                        <ul class="mb-0">
                            {% for field in form %}
                                {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <form method="post" id="loanForm" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="customer_face_capture" id="customerFaceCapture" value="{% if form.instance.customer_face_capture %}{{ form.instance.customer_face_capture|escapejs }}{% endif %}">
                        <input type="hidden" name="item_photos" id="itemPhotosData" value="">
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-user me-2"></i>Customer & Authentication
                                </h5>
                            </div>
                            
                            <!-- Customer and Biometric Authentication Row -->
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        {{ form.customer|as_crispy_field }}
                                    </div>
                                    <div class="col-12">
                                        {{ form.branch|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <!-- Biometric Authentication Section -->
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableBiometricAuth">
                                            <label class="form-check-label" for="enableBiometricAuth">
                                                <i class="fas fa-fingerprint me-2"></i>Use Biometric Authentication
                                            </label>
                                        </div>
                                    </div>
                                    <div class="card-body" id="biometricAuthSection" style="display: none;">
                                        <div id="biometricStatus"></div>
                                        <div class="text-center mb-2">
                                            <button type="button" class="btn btn-outline-primary" id="verifyBiometricBtn">
                                                <i class="fas fa-fingerprint me-2"></i>Verify Customer Biometric
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <h5 class="card-title mb-2 d-flex align-items-center">
                                    <i class="fas fa-camera me-2"></i>Photos
                                    <button class="btn btn-sm btn-outline-secondary ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#photoSection">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </h5>
                                <div id="photoSection" class="collapse show">
                                    <div class="row g-2">
                                        <!-- Customer Photo -->
                                        <div class="col-md-6">
                                            <div class="card card-sm h-100">
                                                <div class="card-header py-1 px-2 bg-light">
                                                    <small><strong>Customer Photo</strong></small>
                                                </div>
                                                <div class="card-body p-2">
                                                    <div class="row g-2">
                                                        <div class="col-md-6">
                                                            <div id="cameraView" class="border rounded" style="height: 150px; position: relative;">
                                                                <video id="cameraStream" style="width: 100%; height: 100%; object-fit: cover;" autoplay playsinline></video>
                                                                <canvas id="photoCanvas" style="display:none;"></canvas>
                                                            </div>
                                                            <div class="d-grid gap-1 mt-1">
                                                                <button type="button" class="btn btn-sm btn-primary" id="captureBtn">
                                                                    <i class="fas fa-camera me-1"></i>Capture
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div id="photoPreview" class="border rounded d-flex align-items-center justify-content-center bg-light" style="height: 150px;">
                                                                {% if form.instance.customer_face_capture %}
                                                                    <img id="capturedPhoto" class="img-fluid" style="max-height: 150px;" src="{{ form.instance.customer_face_capture }}">
                                                                {% else %}
                                                                    <span id="noCaptureText" class="small text-muted">No photo</span>
                                                                {% endif %}
                                                            </div>
                                                            <div class="d-grid gap-1 mt-1">
                                                                <button type="button" class="btn btn-sm btn-outline-secondary" id="retakeBtn">
                                                                    <i class="fas fa-redo me-1"></i>Retake
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Gold Item Photos -->
                                        <div class="col-md-6">
                                            <div class="card card-sm h-100">
                                                <div class="card-header py-1 px-2 bg-light">
                                                    <small><strong>Gold Item Photos</strong> <span class="badge bg-danger" id="photoCountBadge">0</span></small>
                                                </div>
                                                <div class="card-body p-2">
                                                    <div class="row g-2">
                                                        <div class="col-md-6">
                                                            <div id="itemCameraView" class="border rounded" style="height: 150px; position: relative;">
                                                                <video id="itemCameraStream" style="width: 100%; height: 100%; object-fit: cover;" autoplay playsinline></video>
                                                                <canvas id="itemPhotoCanvas" style="display:none;"></canvas>
                                                            </div>
                                                            <div class="d-grid gap-1 mt-1">
                                                                <button type="button" class="btn btn-sm btn-primary" id="captureItemBtn">
                                                                    <i class="fas fa-camera me-1"></i>Capture Item
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="border rounded p-1 bg-light position-relative" style="height: 150px; overflow-y: auto;">
                                                                <div id="noItemPhotosText" class="text-center text-muted p-2 small">
                                                                    <small>No photos available</small>
                                                                </div>
                                                                <div id="itemPhotosContainer" class="row g-1">
                                                                    {% if item_photos_list %}
                                                                        {% for photo in item_photos_list %}
                                                                            <div class="col-6">
                                                                                <div class="position-relative">
                                                                                    <img src="{{ photo }}" class="img-thumbnail" alt="Item photo">
                                                                                    <div class="bg-dark bg-opacity-50 text-white position-absolute bottom-0 start-0 end-0 small text-center">
                                                                                        Photo {{ forloop.counter }}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                </div>
                                                                <button type="button" class="btn btn-sm btn-outline-danger position-absolute bottom-0 end-0 m-1" id="clearItemPhotosBtn" {% if not item_photos_list %}disabled{% endif %}>
                                                                    <i class="fas fa-trash-alt"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-footer p-1 bg-light">
                                                    <p class="mb-0 small text-muted"><i class="fas fa-info-circle"></i> Take multiple photos from different angles</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gold Item Details Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-gem me-2"></i>Gold Item Details
                                </h5>
                            </div>
                            <div class="col-md-6">
                                {{ form.item_name|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.item_category|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.market_price_22k|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.gold_karat|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.gross_weight|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.stone_weight|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.net_weight|as_crispy_field }}
                            </div>
                            <div class="col-md-12">
                                {{ form.item_description|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-money-bill-wave me-2"></i>Loan Details
                                </h5>
                            </div>
                            <div class="col-md-6">
                                {{ form.scheme|as_crispy_field }}
                                <div id="scheme-info" class="alert alert-info small mb-0 mt-2" style="display: none;">
                                    <span id="scheme-details"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                {{ form.principal_amount|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.processing_fee|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.distribution_amount|as_crispy_field }}
                            </div>
                            <!-- Interest rate field removed from UI -->
                            <input type="hidden" id="id_interest_rate" name="interest_rate" value="12.00">
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-calendar me-2"></i>Dates
                                </h5>
                            </div>
                            <div class="col-md-4">
                                {{ form.issue_date|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.due_date|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.grace_period_end|as_crispy_field }}
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'loan_list' %}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitLoanBtn">
                                <i class="fas fa-save me-2"></i>
                                {% if form.instance.pk %}Update{% else %}Create{% endif %} Loan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        // Camera functionality
        const cameraStream = document.getElementById('cameraStream');
        const photoCanvas = document.getElementById('photoCanvas');
        const capturedPhoto = document.getElementById('capturedPhoto') || document.createElement('img');
        capturedPhoto.id = 'capturedPhoto';
        capturedPhoto.className = 'img-fluid';
        capturedPhoto.style.maxHeight = '150px';
        capturedPhoto.style.display = 'none';
        
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const noCaptureText = document.getElementById('noCaptureText');
        const customerFaceCapture = document.getElementById('customerFaceCapture');
        const photoPreview = document.getElementById('photoPreview');
        
        // Make sure photoPreview contains capturedPhoto
        if (photoPreview && !document.getElementById('capturedPhoto')) {
            photoPreview.appendChild(capturedPhoto);
        }
        
        let stream = null;
        let cameraInitialized = false;
        
        // Initialize customer face capture from existing data if available
        {% if form.instance.customer_face_capture %}
            console.log("Initializing existing customer photo");
            customerFaceCapture.value = "{{ form.instance.customer_face_capture|escapejs }}";
            if (capturedPhoto) {
                capturedPhoto.src = "{{ form.instance.customer_face_capture|escapejs }}";
                capturedPhoto.style.display = 'block';
                if (noCaptureText) noCaptureText.style.display = 'none';
                if (retakeBtn) retakeBtn.disabled = false;
            }
        {% endif %}
        
        // Start the camera with retry mechanism
        async function startCamera(retryCount = 0) {
            try {
                if (retryCount > 3) {
                    console.error('Failed to start camera after multiple attempts');
                    showAlert('Could not access camera. Please check camera permissions or try using a different browser.', 'danger');
                    return;
                }
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                cameraStream.srcObject = stream;
                cameraStream.onloadedmetadata = function() {
                    cameraStream.play()
                        .then(() => {
                            console.log('Camera started successfully');
                            cameraInitialized = true;
                        })
                        .catch(err => {
                            console.error('Error playing camera stream:', err);
                            // Try to recover
                            setTimeout(() => startCamera(retryCount + 1), 1000);
                        });
                };
                
            } catch (err) {
                console.error('Error accessing camera:', err);
                showAlert('Could not access camera. Please ensure you have granted camera permissions.', 'danger');
                
                // Try again with a delay
                if (retryCount < 3) {
                    console.log(`Retrying camera initialization (attempt ${retryCount + 1})...`);
                    setTimeout(() => startCamera(retryCount + 1), 1000);
                }
            }
        }
        
        // Start camera when page loads
        startCamera();
        
        // Retry button for camera access
        const addRetryButton = () => {
            const retryButton = document.createElement('button');
            retryButton.className = 'btn btn-sm btn-warning mt-1';
            retryButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Retry Camera';
            retryButton.onclick = () => {
                retryButton.disabled = true;
                retryButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Retrying...';
                startCamera();
                setTimeout(() => {
                    retryButton.disabled = false;
                    retryButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Retry Camera';
                }, 3000);
            };
            
            const cameraContainer = document.getElementById('cameraView');
            if (cameraContainer && !document.getElementById('retry-camera-btn')) {
                retryButton.id = 'retry-camera-btn';
                cameraContainer.appendChild(retryButton);
            }
        };
        
        // Add retry button after a delay if camera doesn't load
        setTimeout(() => {
            if (!cameraInitialized) {
                addRetryButton();
            }
        }, 3000);
        
        // Capture photo function
        captureBtn.addEventListener('click', function() {
            if (!cameraStream.srcObject || !cameraInitialized) {
                showAlert('Camera not ready. Please ensure camera permissions are granted and retry.', 'warning');
                addRetryButton();
                return;
            }
            
            try {
                // Set the canvas dimensions to match the video
                photoCanvas.width = cameraStream.videoWidth || 640;
                photoCanvas.height = cameraStream.videoHeight || 480;
                
                if (photoCanvas.width === 0 || photoCanvas.height === 0) {
                    console.error('Invalid canvas dimensions:', photoCanvas.width, photoCanvas.height);
                    showAlert('Cannot capture photo. Camera stream not properly initialized.', 'danger');
                    return;
                }
                
                // Draw the current video frame to the canvas
                const context = photoCanvas.getContext('2d');
                context.drawImage(cameraStream, 0, 0, photoCanvas.width, photoCanvas.height);
                
                // Convert the canvas to a data URL and display the captured photo
                const photoDataUrl = photoCanvas.toDataURL('image/jpeg');
                capturedPhoto.src = photoDataUrl;
                capturedPhoto.style.display = 'block';
                if (noCaptureText) noCaptureText.style.display = 'none';
                
                // Save the photo data in the hidden input
                customerFaceCapture.value = photoDataUrl;
                
                // Enable the retake button
                if (retakeBtn) retakeBtn.disabled = false;
                
                // Show success message
                showAlert('Customer photo captured successfully!', 'success');
            } catch (err) {
                console.error('Error capturing photo:', err);
                showAlert('Failed to capture photo. Please try again.', 'danger');
            }
        });
        
        // Retake photo function
        retakeBtn.addEventListener('click', function() {
            // Just hide the preview but don't clear the value
            capturedPhoto.style.display = 'none';
            if (noCaptureText) noCaptureText.style.display = 'block';
            
            // Important: Don't clear the customerFaceCapture value yet
            // This ensures the original photo is still submitted if no new photo is taken
            
            // Show alert that a new photo should be captured
            showAlert('Ready to capture new customer photo. Click the Capture button.', 'info');
        });
        
        // Biometric verification functionality
        const enableBiometricAuth = document.getElementById('enableBiometricAuth');
        const biometricAuthSection = document.getElementById('biometricAuthSection');
        const verifyBiometricBtn = document.getElementById('verifyBiometricBtn');
        const biometricStatus = document.getElementById('biometricStatus');
        let biometricVerified = false;
        
        // Toggle biometric authentication
        enableBiometricAuth.addEventListener('change', function() {
            if (this.checked) {
                biometricAuthSection.style.display = 'block';
            } else {
                biometricAuthSection.style.display = 'none';
                biometricVerified = true; // Skip verification if disabled
            }
        });
        
        // Biometric verification function
        verifyBiometricBtn.addEventListener('click', function() {
            const customerId = $('#id_customer').val();
            
            if (!customerId) {
                showBiometricStatus('Please select a customer first', 'warning');
                return;
            }
            
            // Simulate biometric verification (in a real app, this would call your biometric verification API)
            simulateBiometricVerification(customerId);
        });
        
        // Simulate biometric verification (replace with actual API call in production)
        function simulateBiometricVerification(customerId) {
            showBiometricStatus('Verifying biometrics...', 'info');
            
            // Simulated verification - in production, replace with actual API call
            setTimeout(function() {
                // Successfully verified (for demo)
                biometricVerified = true;
                showBiometricStatus('Biometric verification successful!', 'success');
                verifyBiometricBtn.disabled = true;
                verifyBiometricBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Verified';
                verifyBiometricBtn.classList.remove('btn-outline-primary');
                verifyBiometricBtn.classList.add('btn-success');
            }, 1500);
        }
        
        // Display biometric status
        function showBiometricStatus(message, type) {
            biometricStatus.innerHTML = `<div class="alert alert-${type} mb-3">${message}</div>`;
        }
        
        // Function to display alert message
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insert at the top of the form
            const form = document.querySelector('form');
            form.insertBefore(alertDiv, form.firstChild);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }
        
        // Gold Item Photo Capture Functionality
        const itemCameraStream = document.getElementById('itemCameraStream');
        const itemPhotoCanvas = document.getElementById('itemPhotoCanvas');
        const captureItemBtn = document.getElementById('captureItemBtn');
        const itemPhotosContainer = document.getElementById('itemPhotosContainer');
        const noItemPhotosText = document.getElementById('noItemPhotosText') || document.createElement('div');
        const clearItemPhotosBtn = document.getElementById('clearItemPhotosBtn') || document.createElement('button');
        const photoCountBadge = document.getElementById('photoCountBadge');
        const itemPhotosData = document.getElementById('itemPhotosData');
        let itemStream = null;
        let itemPhotos = [];
        
        // Initialize item photos from existing data if available
        {% if item_photos_list %}
            console.log("Initializing existing item photos");
            
            try {
                {% for photo in item_photos_list %}
                    itemPhotos.push({
                        id: 'existing-item-photo-{{ forloop.counter }}',
                        dataUrl: '{{ photo|escapejs }}'
                    });
                {% endfor %}
                
                // Update the hidden input with the existing photos
                updateItemPhotosData();
                
                // Update the display
                if (itemPhotos.length > 0 && noItemPhotosText) {
                    noItemPhotosText.style.display = 'none';
                }
                
                if (clearItemPhotosBtn) {
                    clearItemPhotosBtn.disabled = false;
                }
                
                // Update the photo count badge
                if (photoCountBadge) {
                    photoCountBadge.textContent = `${itemPhotos.length} Photos`;
                    photoCountBadge.className = 'badge me-2 ' + 
                        (itemPhotos.length < 2 ? 'bg-danger' : 'bg-success');
                }
            } catch (error) {
                console.error("Error initializing item photos:", error);
            }
        {% endif %}
        
        // Start the item camera
        async function startItemCamera() {
            try {
                itemStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'environment' // Use back camera if available
                    }
                });
                itemCameraStream.srcObject = itemStream;
            } catch (err) {
                console.error('Error accessing camera for item photos:', err);
                showAlert('Could not access camera for item photos. Please check camera permissions.', 'danger');
            }
        }
        
        // Start item camera when page loads
        startItemCamera();
        
        // Capture item photo function
        captureItemBtn.addEventListener('click', function() {
            // Set the canvas dimensions to match the video
            itemPhotoCanvas.width = itemCameraStream.videoWidth;
            itemPhotoCanvas.height = itemCameraStream.videoHeight;
            
            // Draw the current video frame to the canvas
            const context = itemPhotoCanvas.getContext('2d');
            context.drawImage(itemCameraStream, 0, 0, itemPhotoCanvas.width, itemPhotoCanvas.height);
            
            // Convert the canvas to a data URL
            const photoDataUrl = itemPhotoCanvas.toDataURL('image/jpeg');
            
            // Add the photo to the collection
            addItemPhoto(photoDataUrl);
            
            // Update the photos data in the hidden input
            updateItemPhotosData();
            
            // Enable the clear button
            if (clearItemPhotosBtn) clearItemPhotosBtn.disabled = false;
        });
        
        // Add an item photo to the collection
        function addItemPhoto(photoDataUrl) {
            const photoId = 'item-photo-' + Date.now();
            itemPhotos.push({ id: photoId, dataUrl: photoDataUrl });
            
            // Hide the "no photos" text if this is the first photo
            if (itemPhotos.length === 1 && noItemPhotosText) {
                noItemPhotosText.style.display = 'none';
            }
            
            // Create a thumbnail element
            const thumbnailCol = document.createElement('div');
            thumbnailCol.className = 'col-6';
            thumbnailCol.innerHTML = `
                <div class="position-relative">
                    <img src="${photoDataUrl}" class="img-thumbnail" alt="Item photo ${itemPhotos.length}">
                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 delete-photo" data-photo-id="${photoId}">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="bg-dark bg-opacity-50 text-white position-absolute bottom-0 start-0 end-0 small text-center">
                        Photo ${itemPhotos.length}
                    </div>
                </div>
            `;
            if (itemPhotosContainer) {
                itemPhotosContainer.appendChild(thumbnailCol);
                
                // Add event listener to delete button
                const deleteBtn = thumbnailCol.querySelector('.delete-photo');
                deleteBtn.addEventListener('click', function() {
                    const photoId = this.getAttribute('data-photo-id');
                    deleteItemPhoto(photoId, this.closest('.col-6'));
                });
            }
            
            // Update the photo count badge
            updatePhotoCountBadge();
        }
        
        // Delete an item photo
        function deleteItemPhoto(photoId, element) {
            // Remove from the DOM
            element.remove();
            
            // Remove from the array
            itemPhotos = itemPhotos.filter(photo => photo.id !== photoId);
            
            // Show the "no photos" text if this was the last photo
            if (itemPhotos.length === 0 && noItemPhotosText) {
                noItemPhotosText.style.display = 'block';
                if (clearItemPhotosBtn) clearItemPhotosBtn.disabled = true;
            }
            
            // Update the photos data in the hidden input
            updateItemPhotosData();
            
            // Update the photo count badge
            updatePhotoCountBadge();
        }
        
        // Update the item photos data in the hidden input
        function updateItemPhotosData() {
            // Store only the data URLs to save space
            const dataUrls = itemPhotos.map(photo => photo.dataUrl);
            itemPhotosData.value = JSON.stringify(dataUrls);
        }
        
        // Update the photo count badge
        function updatePhotoCountBadge() {
            if (photoCountBadge) {
                photoCountBadge.textContent = `${itemPhotos.length} Photos`;
                photoCountBadge.className = 'badge me-2 ' + 
                    (itemPhotos.length < 2 ? 'bg-danger' : 'bg-success');
            }
        }
        
        // Clear all item photos
        if (clearItemPhotosBtn) {
            clearItemPhotosBtn.addEventListener('click', function() {
                // Confirm before clearing
                if (confirm('Are you sure you want to clear all item photos?')) {
                    // Clear the photos container
                    if (itemPhotosContainer) itemPhotosContainer.innerHTML = '';
                    
                    // Reset the photos array
                    itemPhotos = [];
                    
                    // Show the "no photos" text
                    if (noItemPhotosText) noItemPhotosText.style.display = 'block';
                    
                    // Clear the hidden input
                    itemPhotosData.value = '';
                    
                    // Disable the clear button
                    clearItemPhotosBtn.disabled = true;
                    
                    // Update the photo count badge
                    updatePhotoCountBadge();
                }
            });
        }
        
        // Add scheme handling
        function updateSchemeInfo() {
            const scheme = $('#id_scheme').val();
            const schemeInfo = $('#scheme-info');
            const schemeDetails = $('#scheme-details');
            let interestRate = 0;
            let schemeText = '';
            
            if (scheme === 'standard') {
                interestRate = 12.00;
                schemeText = '<strong>Standard Scheme:</strong> 12% interest rate, can only be closed after 3 months from loan date.';
                schemeInfo.removeClass('alert-info alert-warning').addClass('alert-info');
            } else if (scheme === 'flexible') {
                interestRate = 24.00;
                schemeText = '<strong>Flexible Scheme:</strong> 24% interest rate, but no interest if closed within 25 days from loan date.';
                schemeInfo.removeClass('alert-info alert-warning').addClass('alert-warning');
            }
            
            // Update interest rate field
            $('#id_interest_rate').val(interestRate);
            
            // Update scheme info display
            schemeDetails.html(schemeText);
            schemeInfo.show();
            
            // Update due dates based on scheme
            updateDueDates();
        }
        
        // Function to update due dates based on loan date and scheme
        function updateDueDates() {
            const issueDate = $('#id_issue_date').val();
            const scheme = $('#id_scheme').val();
            
            if (issueDate) {
                const issueDateObj = new Date(issueDate);
                let dueDate = new Date(issueDateObj);
                
                // Set due date based on scheme (1 year for standard, 3 months for flexible)
                if (scheme === 'standard') {
                    dueDate.setFullYear(dueDate.getFullYear() + 1); // Add 1 year
                } else {
                    dueDate.setDate(dueDate.getDate() + 90); // Add 90 days (3 months)
                }
                
                // Set grace period as due date + 15 days
                let gracePeriod = new Date(dueDate);
                gracePeriod.setDate(gracePeriod.getDate() + 15);
                
                // Format dates as YYYY-MM-DD for input fields
                const dueDateFormatted = dueDate.toISOString().split('T')[0];
                const gracePeriodFormatted = gracePeriod.toISOString().split('T')[0];
                
                // Set the values
                $('#id_due_date').val(dueDateFormatted);
                $('#id_grace_period_end').val(gracePeriodFormatted);
            }
        }
        
        // Set up scheme change handler
        $('#id_scheme').on('change', updateSchemeInfo);
        
        // Set up loan date change handler
        $('#id_issue_date').on('change', updateDueDates);
        
        // Run on page load to set initial values
        updateSchemeInfo();
        
        // If loan date is already set on page load, update due dates accordingly
        if ($('#id_issue_date').val()) {
            updateDueDates();
        }
        
        // Original loan form JS code
        const KARAT_PURITY = {
            '24': 0.999,
            '22': 0.916,
            '21': 0.875,
            '20': 0.833,
            '18': 0.750,
            '14': 0.583
        };

        // Debounce function to prevent multiple rapid updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            }
        }

        // Calculate net weight when gross weight or stone weight changes
        const calculateNetWeight = function() {
            const grossWeight = parseFloat($('#id_gross_weight').val()) || 0;
            const stoneWeight = parseFloat($('#id_stone_weight').val()) || 0;
            const netWeight = Math.max(0, grossWeight - stoneWeight);
            $('#id_net_weight').val(netWeight.toFixed(3));
            
            // Auto-recalculate principal amount whenever net weight changes
            calculateGoldValue();
        };

        // Calculate gold value and suggest principal amount
        const calculateGoldValue = debounce(function() {
            const marketPrice = parseFloat($('#id_market_price_22k').val()) || 0;
            const selectedKarat = $('#id_gold_karat').val();
            const netWeight = parseFloat($('#id_net_weight').val()) || 0;
            
            // Remove any existing suggestion messages
            $('.gold-value-message').remove();
            
            if (marketPrice && selectedKarat && netWeight > 0) {
                const purityRatio = KARAT_PURITY[selectedKarat] / KARAT_PURITY['22'];
                const goldValue = marketPrice * netWeight * purityRatio;
                
                // Calculate suggested principal (75% of gold value)
                const suggestedPrincipal = Math.round(goldValue * 0.75);
                
                // Calculate minimum and maximum allowed values
                const minPrincipal = Math.round(goldValue * 0.5);
                const maxPrincipal = Math.round(goldValue * 0.85);

                // Automatically fill in the suggested principal amount
                $('#id_principal_amount').val(suggestedPrincipal);
                
                // Trigger the distribution amount calculation
                calculateDistributionAmount();
                
                // Create a compact info message with mild custom styling
                const messageDiv = $('<div class="gold-value-message small mt-1"></div>')
                    .css('color', '#5470b0')  // Mild blue color
                    .html(`<i class="fas fa-info-circle"></i> Gold value: ₹${goldValue.toFixed(0)} | Principal set to ₹${suggestedPrincipal} (75%) | Range: ₹${minPrincipal}-₹${maxPrincipal}`);
                
                // Insert after the principal amount field
                messageDiv.insertAfter('#div_id_principal_amount .form-text');
            }
        }, 300);

        // Calculate distribution amount when principal or processing fee changes
        const calculateDistributionAmount = function() {
            const principal = parseFloat($('#id_principal_amount').val()) || 0;
            // Round principal to whole number
            $('#id_principal_amount').val(Math.round(principal));
            
            // Calculate processing fee as 1% of principal amount
            const processingFeePercentage = 0.01; // Fixed at 1%
            const processingFeeAmount = Math.round(principal * processingFeePercentage);
            
            // Display the processing fee amount instead of percentage
            $('#id_processing_fee')
                .val(processingFeeAmount);
            
            const distributionAmount = principal - processingFeeAmount;
            
            $('#id_distribution_amount')
                .val(Math.round(distributionAmount));
        };

        // Set up event handlers
        $('#id_gross_weight, #id_stone_weight').on('input', calculateNetWeight);
        $('#id_market_price_22k, #id_gold_karat, #id_net_weight').on('input', calculateGoldValue);
        $('#id_principal_amount')
            .on('input', calculateDistributionAmount)
            .trigger('input'); // Trigger on page load

        // Validate principal amount against min/max
        $('#id_principal_amount').on('change', function() {
            const marketPrice = parseFloat($('#id_market_price_22k').val()) || 0;
            const selectedKarat = $('#id_gold_karat').val();
            const netWeight = parseFloat($('#id_net_weight').val()) || 0;
            const principal = parseFloat($(this).val()) || 0;
            
            // Remove any existing error messages
            $('.principal-error').remove();
            
            if (marketPrice && selectedKarat && netWeight > 0) {
                const purityRatio = KARAT_PURITY[selectedKarat] / KARAT_PURITY['22'];
                const goldValue = marketPrice * netWeight * purityRatio;
                const minPrincipal = Math.round(goldValue * 0.5);
                const maxPrincipal = Math.round(goldValue * 0.85);
                
                if (principal < minPrincipal || principal > maxPrincipal) {
                    const errorMsg = $('<div class="principal-error text-danger small mt-1"></div>')
                        .text(principal < minPrincipal 
                            ? `Principal must be at least ₹${minPrincipal} (50% of gold value)`
                            : `Principal cannot exceed ₹${maxPrincipal} (85% of gold value)`);
                    
                    $(this).after(errorMsg);
                }
            }
        });
        
        // Add form submission handling
        $('#loanForm').on('submit', function(event) {
            // Ensure customer face capture is properly included
            if (customerFaceCapture.value) {
                // Log the image data length to console for debugging
                console.log("Submitting customer face capture, data length:", customerFaceCapture.value.length);
            } else {
                console.log("No customer face capture data to submit");
            }
        });
        
        // Clean up when leaving the page
        $(window).on('beforeunload', function() {
            // Stop the camera streams if they exist
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (itemStream) {
                itemStream.getTracks().forEach(track => track.stop());
            }
        });
    });
</script>
{% endblock %}